<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>焼き菓子 在庫・注文管理システム</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- カスタムスタイルシート -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: none;
        }
        .card-header {
            font-weight: bold;
            background-color: #ffffff;
            border-bottom: 1px solid #e9ecef;
            font-size: 1.1rem;
            padding: 1rem 1.25rem;
        }
        .nav-tabs .nav-link {
            font-weight: 500;
            border: none;
            border-bottom: 3px solid transparent;
        }
        .nav-tabs .nav-link.active {
            border-bottom-color: #0d6efd;
            color: #0d6efd;
        }
        /* 不足時のカードスタイル（赤） */
        .shortage-card {
            border-left: 5px solid #dc3545;
        }
        .shortage-header {
            background-color: #dc3545;
            color: white;
        }
        /* 在庫十分時のカードスタイル（緑） */
        .sufficient-stock-card {
            border-left: 5px solid #28a745; /* 緑色 */
        }
        .sufficient-stock-header {
            background-color: #28a745; /* 緑色 */
            color: white;
        }
        .shortage-list .list-group-item {
            color: #dc3545;
            font-weight: bold;
            background-color: #fdf2f2;
        }
        .weekly-section {
            margin-bottom: 2rem;
        }
        .editable-stock-input {
            width: 80px;
            text-align: right;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            padding: .375rem .75rem;
        }
        /* 数値入力の矢印（スピンボタン）を非表示にする */
        .editable-stock-input::-webkit-outer-spin-button,
        .editable-stock-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .editable-stock-input {
            -moz-appearance: textfield;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-item-details {
            flex-grow: 1;
        }
        .order-edit-icon {
            cursor: pointer;
            margin-left: 10px;
            color: #0d6efd;
            transition: transform 0.2s;
        }
        .order-edit-icon:hover {
            transform: scale(1.2);
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .sticky-top {
            top: 20px;
        }
        .new-order-item-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .new-order-item-row .form-select,
        .new-order-item-row .input-group {
            margin-right: 10px;
        }
        .new-order-item-row .input-group {
            width: 140px; /* Adjust width for quantity input */
        }
    </style>
</head>
<body>

    <div class="container mt-4">
        <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
            <i class="bi bi-journals fs-2 me-3 text-primary"></i>
            <span class="fs-4">焼き菓子 在庫・注文管理システム</span>
        </header>

        <!-- タブナビゲーション -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-tab-pane" type="button" role="tab" aria-controls="order-tab-pane" aria-selected="true"><i class="bi bi-cart-check-fill me-2"></i>注文管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="material-stock-tab" data-bs-toggle="tab" data-bs-target="#material-stock-tab-pane" type="button" role="tab" aria-controls="material-stock-tab-pane" aria-selected="false"><i class="bi bi-egg-fried me-2"></i>原材料 在庫管理</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="product-stock-tab" data-bs-toggle="tab" data-bs-target="#product-stock-tab-pane" type="button" role="tab" aria-controls="product-stock-tab-pane" aria-selected="false"><i class="bi bi-box-seam-fill me-2"></i>製造在庫管理</button>
            </li>
        </ul>

        <!-- タブコンテンツ -->
        <div class="tab-content" id="myTabContent">
            <!-- 注文管理タブ -->
            <div class="tab-pane fade show active" id="order-tab-pane" role="tabpanel" aria-labelledby="order-tab" tabindex="0">
                <div class="row mt-4">
                    <!-- 左側：注文リストと不足レポート -->
                    <div class="col-lg-8">
                        <div id="order-display-area">
                            <!-- 週ごとの注文がここに表示されます -->
                        </div>
                    </div>
                    <!-- 右側：新規注文追加 -->
                    <div class="col-lg-4">
                        <div class="card sticky-top">
                            <div class="card-header">
                                <i class="bi bi-plus-circle-fill me-2"></i>新規注文の追加
                            </div>
                            <div class="card-body">
                                <form id="add-order-form">
                                    <div class="mb-3">
                                        <label for="customer-name" class="form-label">注文者名</label>
                                        <input type="text" class="form-control" id="customer-name" list="customer-names" required>
                                        <datalist id="customer-names">
                                            <!-- 顧客名オプションはJSで追加されます -->
                                        </datalist>
                                    </div>
                                    <div id="new-order-items-container" class="mb-3">
                                        <!-- 動的に追加される商品行 -->
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mb-3" id="add-product-to-order">
                                        <i class="bi bi-plus-circle me-1"></i>商品を追加
                                    </button>
                                    <div class="mb-3">
                                        <label for="due-date" class="form-label">納期</label>
                                        <input type="date" class="form-control" id="due-date" required>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">注文を追加</button>
                                        <button type="button" class="btn btn-outline-secondary" id="reset-order-form">リセット</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 原材料 在庫管理タブ -->
            <div class="tab-pane fade" id="material-stock-tab-pane" role="tabpanel" aria-labelledby="material-stock-tab" tabindex="0">
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="bi bi-list-check me-2"></i>原材料 在庫一覧
                    </div>
                    <div class="card-body">
                        <p class="text-muted">現在の原材料の在庫状況です。在庫数を直接編集するか、[+]/[-]ボタンで更新してください。</p>
                        <ul class="list-group" id="material-stock-list">
                            <!-- 原材料在庫がここに表示されます -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 製造在庫管理タブ -->
            <div class="tab-pane fade" id="product-stock-tab-pane" role="tabpanel" aria-labelledby="product-stock-tab" tabindex="0">
                <div class="card mt-4">
                    <div class="card-header">
                        <i class="bi bi-list-check me-2"></i>製造在庫一覧
                    </div>
                    <div class="card-body">
                        <p class="text-muted">現在の完成品の在庫状況です。在庫数を直接編集するか、[+]/[-]ボタンで更新してください。</p>
                        <ul class="list-group" id="product-stock-list">
                            <!-- 製造在庫がここに表示されます -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 注文編集モーダル -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">注文の編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-order-form">
                        <input type="hidden" id="edit-order-id">
                        <div class="mb-3">
                            <label for="edit-customer-name" class="form-label">注文者名</label>
                            <input type="text" class="form-control" id="edit-customer-name" list="customer-names" required>
                            <datalist id="customer-names">
                                <!-- 顧客名オプションはJSで追加されます -->
                            </datalist>
                        </div>
                        <div id="edit-order-items-container" class="mb-3">
                            <!-- 動的に追加される商品行 -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mb-3" id="add-product-to-edit-order">
                            <i class="bi bi-plus-circle me-1"></i>商品を追加
                        </button>
                        <div class="mb-3">
                            <label for="edit-due-date" class="form-label">納期</label>
                            <input type="date" class="form-control" id="edit-due-date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="delete-order-button">削除</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="save-edited-order">変更を保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- メッセージ表示用のトースト -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <i class="bi bi-info-circle-fill me-2"></i>
          <strong class="me-auto" id="toast-title">メッセージ</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
          <!-- メッセージ本文 -->
        </div>
      </div>
    </div>

    <!-- カスタム確認モーダル -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="confirmModalLabel">確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    <!-- 確認メッセージがここに表示されます -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase JS -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        document.addEventListener('DOMContentLoaded', async () => {

            const appToast = new bootstrap.Toast(document.getElementById('appToast'));

            /**
             * トーストメッセージを表示する関数
             * @param {string} title - トーストのタイトル
             * @param {string} message - トーストの本文
             * @param {string} type - 'info', 'success', 'error', 'warning' のいずれか (デフォルト: 'info')
             */
            function showToast(title, message, type = 'info') {
                const toastTitle = document.getElementById('toast-title');
                const toastBody = document.getElementById('toast-body');
                const toastHeader = toastTitle.parentElement;
                
                toastTitle.textContent = title;
                toastBody.textContent = message;

                // アイコンと色の変更
                const icon = toastHeader.querySelector('i');
                toastHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white');
                icon.classList.remove('bi-check-circle-fill', 'bi-exclamation-triangle-fill', 'bi-info-circle-fill');

                switch(type) {
                    case 'success':
                        toastHeader.classList.add('bg-success', 'text-white');
                        icon.classList.add('bi-check-circle-fill');
                        break;
                    case 'error':
                        toastHeader.classList.add('bg-danger', 'text-white');
                        icon.classList.add('bi-exclamation-triangle-fill');
                        break;
                    case 'warning': // 'warning' タイプを追加
                        toastHeader.classList.add('bg-warning', 'text-white');
                        icon.classList.add('bi-exclamation-triangle-fill');
                        break;
                    default:
                        icon.classList.add('bi-info-circle-fill');
                }
                
                appToast.show();
            }

            // --- Supabase Initialization ---
            let supabase;
            let materials = {}; // Supabaseから取得したデータを格納
            let products = {};  // Supabaseから取得したデータを格納
            let orders = [];    // Supabaseから取得したデータを格納

            // Supabaseプロジェクトの設定
            const SUPABASE_URL = 'https://fleesjtbxguyiatdholp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZWVzanRieGd1eWlhdGRob2xwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4MTg5MjksImV4cCI6MjA2NzM5NDkyOX0.4Yiq-Jm6RZ5N64DH5lYFN3n6WI2FB0FT0Bv_YJnjKsM';

            // 初期データ定義 (Supabaseテーブルが空の場合に投入される)
            // !!! 重要 !!!
            // Supabaseの 'materials' および 'products' テーブルの 'id' カラムは、
            // 必ず PostgreSQL の TEXT 型に設定してください。
            // 'orders' テーブルの 'id' カラムは FLOAT8 または NUMERIC 型に設定してください。
            // そうしないと、データの挿入時に "invalid input syntax for type bigint" エラーが発生します。
            const initialMaterialsData = {
                margarine: { name: 'マーガリン', stock: 1000, unit: 'g' },
                sugar_white: { name: '上白糖', stock: 1000, unit: 'g' },
                egg: { name: '卵', stock: 20, unit: '個' },
                walnut: { name: 'クルミ', stock: 200, unit: 'g' },
                raisin: { name: 'レーズン', stock: 200, unit: 'g' },
                cocoa: { name: 'ココア', stock: 100, unit: 'g' },
                sugar_cane: { name: 'きび糖', stock: 500, unit: 'g' },
                sugar_powdered: { name: '粉糖', stock: 500, unit: 'g' },
                fresh_cream: { name: '生クリーム', stock: 200, unit: 'g' },
                chocolate_chip: { name: 'チョコチップ', stock: 300, unit: 'g' },
                matcha: { name: '抹茶', stock: 50, unit: 'g' }
            };

            const initialProductsData = {
                pound_plain_1: { name: 'パウンド プレーン', stock: 10, unit: '本', recipe: { margarine: 75, sugar_white: 75, egg: 1.5 } },
                pound_cocoa_1: { name: 'パウンド ココア', stock: 10, unit: '本', recipe: { margarine: 100, sugar_white: 80, egg: 2, cocoa: 20 } },
                pound_walnut_raisin_1: { name: 'パウンド クルミレーズン', stock: 10, unit: '本', recipe: { margarine: 75, sugar_white: 75, egg: 1.5, walnut: 30, raisin: 50 } },
                pound_matcha_1: { name: 'パウンド 抹茶', stock: 10, unit: '本', recipe: { margarine: 100, sugar_white: 80, egg: 2, matcha: 10 } },
                pound_plain_2pc: { name: 'パウンド プレーン(2個入り)', stock: 20, unit: '袋', recipe: { margarine: 18.75, sugar_white: 18.75, egg: 0.375 } },
                pound_cocoa_2pc: { name: 'パウンド ココア(2個入り)', stock: 20, unit: '袋', recipe: { margarine: 25, sugar_white: 20, egg: 0.5, cocoa: 5 } },
                pound_walnut_raisin_2pc: { name: 'パウンド クルミ＆レーズン(2個入り)', stock: 20, unit: '袋', recipe: { margarine: 18.75, sugar_white: 18.75, egg: 0.375, walnut: 7.5, raisin: 12.5 } },
                pound_matcha_2pc: { name: 'パウンド 抹茶(2個入り)', stock: 20, unit: '袋', recipe: { margarine: 25, sugar_white: 20, egg: 0.5, matcha: 2.5 } },
                chocochip_cookie: { name: 'チョコチップクッキー', stock: 30, unit: '袋', recipe: { margarine: 170, sugar_white: 100, sugar_cane: 100, egg: 1, chocolate_chip: 320 } }, // 1袋あたりのレシピ
                snowball: { name: 'スノーボール', stock: 25, unit: '袋', recipe: { margarine: 70, sugar_powdered: 40, egg: 1, walnut: 50 } },
                diamant_plain: { name: 'ディアマン プレーン', stock: 25, unit: '枚', recipe: { margarine: 60, sugar_powdered: 35, fresh_cream: 10 } },
                diamant_cocoa: { name: 'ディアマン ココア', stock: 25, unit: '枚', recipe: { margarine: 60, sugar_powdered: 35, fresh_cream: 10, cocoa: 10 } },
                galette_bourbonnaise: { name: 'ガレット・ブルボンヌ', stock: 15, unit: '枚', recipe: { margarine: 120, egg: 1 } },
                croquet: { name: 'クロケ', stock: 20, unit: '個', recipe: { margarine: 75, sugar_powdered: 25, sugar_cane: 25, fresh_cream: 25 } }
            };

            // 顧客名リスト
            const customerNames = [
                'いこらもーる', '保健センター・市役所', 'アサヒディード', 'トヨペット貝塚',
                'BFOマルシェ 玉野様', 'ふれあい配食・社協', '泉佐野教会', 'まちの駅かいづか', 'イベント'
            ];

            /**
             * Supabaseテーブルが空の場合に初期データを投入する関数
             * @param {string} tableName - テーブル名
             * @param {object} initialData - 投入する初期データオブジェクト
             */
            async function populateTableIfEmpty(tableName, initialData) {
                const { count, error: countError } = await supabase.from(tableName).select('*', { count: 'exact', head: true });
                if (countError) {
                    console.error(`Error counting ${tableName}:`, countError);
                    showToast('エラー', `${tableName}の初期データチェックに失敗しました。`, 'error');
                    return;
                }
                if (count === 0) {
                    console.log(`Populating initial ${tableName} data...`);
                    // initialDataオブジェクトを、各アイテムに'id'フィールドを持つオブジェクトの配列に変換
                    // !!! 重要 !!!
                    // ここで挿入される 'id' は文字列です。
                    // Supabaseのテーブルで 'id' カラムが TEXT 型であることを確認してください。
                    const dataToInsert = Object.keys(initialData).map(id => ({ id, ...initialData[id] }));
                    const { error: insertError } = await supabase.from(tableName).insert(dataToInsert);
                    if (insertError) {
                        console.error(`Error inserting initial ${tableName} data:`, insertError);
                        showToast('エラー', `${tableName}の初期データ投入に失敗しました。`, 'error');
                    } else {
                        showToast('初期データ設定', `${tableName}の初期データをロードしました。`, 'info');
                    }
                }
            }

            /**
             * Supabaseから全てのデータを取得し、UIをレンダリングする関数
             */
            async function fetchAllDataAndRender() {
                // 原材料の取得
                const { data: materialsData, error: materialsError } = await supabase.from('materials').select('*');
                if (materialsError) {
                    console.error('Error fetching initial materials:', materialsError);
                    showToast('エラー', '原材料データの取得に失敗しました。', 'error');
                } else {
                    // 取得したデータをIDをキーとするオブジェクトに変換して格納
                    materials = materialsData.reduce((acc, item) => {
                        acc[item.id] = item;
                        return acc;
                    }, {});
                }

                // 製品の取得
                const { data: productsData, error: productsError } = await supabase.from('products').select('*');
                if (productsError) {
                    console.error('Error fetching initial products:', productsError);
                    showToast('エラー', '製品データの取得に失敗しました。', 'error');
                } else {
                    // 取得したデータをIDをキーとするオブジェクトに変換して格納
                    products = productsData.reduce((acc, item) => {
                        acc[item.id] = item;
                        return acc;
                    }, {});
                }

                // 注文の取得
                const { data: ordersData, error: ordersError } = await supabase.from('orders').select('*');
                if (ordersError) {
                    console.error('Error fetching initial orders:', ordersError);
                    showToast('エラー', '注文データの取得に失敗しました。', 'error');
                } else {
                    orders = ordersData;
                }

                // 納期で注文をソート
                orders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                renderAll();
            }

            // --- アプリケーションの初期化 ---
            async function initialize() {
                // Supabaseクライアントを初期化
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // テーブルが空の場合に初期データを投入
                await populateTableIfEmpty('materials', initialMaterialsData);
                await populateTableIfEmpty('products', initialProductsData);
                // 注文テーブルは初期データを持たず、空で開始します。

                // 材料のリアルタイムリスナーを設定
                supabase
                    .channel('materials_changes') // チャンネル名を指定
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'materials' }, payload => {
                        console.log('Material change received!', payload);
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            materials[payload.new.id] = payload.new;
                        } else if (payload.eventType === 'DELETE') {
                            delete materials[payload.old.id];
                        }
                        renderMaterialStock();
                        renderOrdersAndShortages(); // 依存するセクションも再レンダリング
                    })
                    .subscribe();

                // 製品のリアルタイムリスナーを設定
                supabase
                    .channel('products_changes') // チャンネル名を指定
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, payload => {
                        console.log('Product change received!', payload);
                        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                            products[payload.new.id] = payload.new;
                        } else if (payload.eventType === 'DELETE') {
                            delete products[payload.old.id];
                        }
                        renderProductStock();
                        renderOrdersAndShortages(); // 依存するセクションも再レンダリング
                    })
                    .subscribe();

                // 注文のリアルタイムリスナーを設定
                supabase
                    .channel('orders_changes') // チャンネル名を指定
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                        console.log('Order change received!', payload);
                        if (payload.eventType === 'INSERT') {
                            orders.push(payload.new);
                        } else if (payload.eventType === 'UPDATE') {
                            const index = orders.findIndex(o => o.id === payload.new.id);
                            if (index !== -1) orders[index] = payload.new;
                        } else if (payload.eventType === 'DELETE') {
                            orders = orders.filter(o => o.id !== payload.old.id);
                        }
                        orders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)); // ソート状態を維持
                        renderOrdersAndShortages();
                    })
                    .subscribe();

                // 全ての初期データを取得し、UIをレンダリング (初期投入後または既存データがある場合)
                await fetchAllDataAndRender();

                const customerNamesDatalist = document.getElementById('customer-names');
                customerNamesDatalist.innerHTML = '';
                customerNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    customerNamesDatalist.appendChild(option);
                });
                
                const today = new Date().toISOString().split("T")[0];
                document.getElementById('due-date').min = today;
                document.getElementById('edit-due-date').min = today;

                addNewProductRowToForm();
            }

            // --- 表示更新関数 ---
            /**
             * 全ての在庫と注文の表示を更新する関数
             */
            function renderAll() {
                renderMaterialStock(); // 原材料在庫の表示を更新
                renderProductStock(); // 製造在庫の表示を更新
                renderOrdersAndShortages(); // 注文と不足レポートの表示を更新
            }

            /**
             * 在庫リスト（原材料または製品）をレンダリングする汎用関数
             * @param {string} listId - リストを表示するUL要素のID
             * @param {object} data - 表示する在庫データ（materialsまたはproducts）
             * @param {string} type - 'material'または'product'
             */
            function renderStockList(listId, data, type) {
                const list = document.getElementById(listId);
                list.innerHTML = ''; // 既存のリストをクリア
                for (const id in data) {
                    const item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <span>${data[id].name}</span>
                        <div class="d-flex align-items-center">
                            <div class="input-group input-group-sm" style="width: 160px;">
                                <button class="btn btn-outline-secondary btn-minus" type="button" data-id="${id}" data-type="${type}">-</button>
                                <input type="number" class="form-control text-center editable-stock-input" value="${data[id].stock}" data-id="${id}" data-type="${type}" min="0" step="0.1">
                                <button class="btn btn-outline-secondary btn-plus" type="button" data-id="${id}" data-type="${type}">+</button>
                            </div>
                            <span class="ms-3" style="width: 40px;">${data[id].unit}</span>
                        </div>
                    `;
                    list.appendChild(item);
                }
                attachStockInputListeners(list); // 入力フィールドのイベントリスナーをアタッチ
                attachStockButtonListeners(list); // ボタンのイベントリスナーをアタッチ
            }

            /**
             * 原材料在庫の表示を更新する関数
             */
            function renderMaterialStock() {
                renderStockList('material-stock-list', materials, 'material');
            }

            /**
             * 製品在庫の表示を更新する関数
             */
            function renderProductStock() {
                renderStockList('product-stock-list', products, 'product');
            }
            
            /**
             * 在庫入力フィールドの変更イベントリスナーをアタッチする関数
             * @param {HTMLElement} listElement - リスト要素
             */
            function attachStockInputListeners(listElement) {
                listElement.querySelectorAll('.editable-stock-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const id = e.target.dataset.id;
                        const type = e.target.dataset.type;
                        const newStock = parseFloat(e.target.value); // 小数点も考慮
                        
                        const tableName = type === 'material' ? 'materials' : 'products';

                        if (!isNaN(newStock) && newStock >= 0) {
                            const { error } = await supabase
                                .from(tableName)
                                .update({ stock: newStock })
                                .eq('id', id); // IDが一致する行を更新

                            if (error) {
                                console.error(`Error updating ${tableName} stock:`, error);
                                showToast('エラー', '在庫の更新に失敗しました。', 'error');
                                e.target.value = (type === 'material' ? materials : products)[id].stock; // 無効な入力の場合は元の値に戻す
                            } else {
                                showToast('在庫更新', `${(type === 'material' ? materials : products)[id].name}の在庫を${newStock}に更新しました。`, 'success');
                                // リアルタイムリスナーがUIを自動更新するため、renderAllは不要
                            }
                        } else {
                            showToast('入力エラー', '有効な数値を入力してください。', 'error');
                            e.target.value = (type === 'material' ? materials : products)[id].stock; // 無効な入力の場合は元の値に戻す
                        }
                    });
                });
            }

            /**
             * 在庫増減ボタンのクリックイベントリスナーをアタッチする関数
             * @param {HTMLElement} listElement - リスト要素
             */
            function attachStockButtonListeners(listElement) {
                listElement.addEventListener('click', async (e) => {
                    const button = e.target.closest('.btn-minus, .btn-plus');
                    if (!button) return; // ボタンでなければ何もしない

                    const id = button.dataset.id;
                    const type = button.dataset.type;
                    const dataObject = type === 'material' ? materials : products;
                    const step = (type === 'material' && id === 'egg') ? 0.5 : 1; // 卵は0.5個単位

                    let currentStock = dataObject[id].stock;
                    if (button.classList.contains('btn-plus')) {
                        currentStock += step;
                    } else if (currentStock > 0) { // 0より小さい値にはしない
                        currentStock -= step;
                    }
                    currentStock = parseFloat(currentStock.toFixed(2)); // 小数点以下2桁に丸める
                    
                    const tableName = type === 'material' ? 'materials' : 'products';
                    const { error } = await supabase
                        .from(tableName)
                        .update({ stock: currentStock })
                        .eq('id', id);

                    if (error) {
                        console.error(`Error updating ${tableName} stock:`, error);
                        showToast('エラー', '在庫の更新に失敗しました。', 'error');
                    } else {
                        // リアルタイムリスナーがUIを自動更新するため、renderAllは不要
                    }
                });
            }

            /**
             * 注文リストと不足レポートを週ごとに表示する関数
             */
            function renderOrdersAndShortages() {
                const area = document.getElementById('order-display-area');
                area.innerHTML = ''; // 既存の内容をクリア

                const now = new Date();
                const startOfThisWeek = getStartOfWeek(now); // 今週の開始日を取得

                const startOfNextWeek = new Date(startOfThisWeek);
                startOfNextWeek.setDate(startOfNextWeek.getDate() + 7);

                const startOfTwoWeeksLater = new Date(startOfThisWeek);
                startOfTwoWeeksLater.setDate(startOfTwoWeeksLater.getDate() + 14);

                const startOfThreeWeeksLater = new Date(startOfThisWeek);
                startOfThreeWeeksLater.setDate(startOfThreeWeeksLater.getDate() + 21); // 三週目（再来週の次）の開始

                const endOfLastWeek = new Date(startOfThisWeek);
                endOfLastWeek.setDate(endOfLastWeek.getDate() - 1); // 先週の終わり（包括的）

                // 各期間の注文をフィルタリング
                const thisWeekOrders = orders.filter(o => {
                    const dueDate = new Date(o.dueDate);
                    return dueDate >= startOfThisWeek && dueDate < startOfNextWeek;
                });

                const nextWeekOrders = orders.filter(o => {
                    const dueDate = new Date(o.dueDate);
                    return dueDate >= startOfNextWeek && dueDate < startOfTwoWeeksLater;
                });

                const twoWeeksLaterSpecificOrders = orders.filter(o => {
                    const dueDate = new Date(o.dueDate);
                    return dueDate >= startOfTwoWeeksLater && dueDate < startOfThreeWeeksLater;
                });

                const threeWeeksLaterAndBeyondOrders = orders.filter(o => {
                    const dueDate = new Date(o.dueDate);
                    return dueDate >= startOfThreeWeeksLater;
                });

                const pastOrders = orders.filter(o => {
                    const dueDate = new Date(o.dueDate);
                    return dueDate <= endOfLastWeek;
                });

                // 各セクションをレンダリング
                // showShortageReport: true -> 不足レポート表示, false -> 不足レポート非表示
                // isCollapsible: true -> 折りたたみ可能, false -> 折りたたみ不可
                area.appendChild(createWeeklySection('今週の注文', thisWeekOrders, 'this-week-report', false, true));
                area.appendChild(createWeeklySection('来週の注文', nextWeekOrders, 'next-week-report', false, true));
                area.appendChild(createWeeklySection('再来週の注文', twoWeeksLaterSpecificOrders, 'two-weeks-later-specific-report', false, true)); // 再来週の注文（折りたたみ不可、レポートあり）
                area.appendChild(createWeeklySection('三週目以降の注文', threeWeeksLaterAndBeyondOrders, 'three-weeks-later-and-beyond-report', true, false)); // 三週目以降の注文（折りたたみ可能、レポートなし）
                area.appendChild(createWeeklySection('先週以前の注文履歴', pastOrders, 'past-orders-report', true, false)); // 先週以前の注文履歴（折りたたみ可能、レポートなし）
            }

            /**
             * 週ごとの注文セクションと不足レポートを作成する関数
             * @param {string} title - セクションのタイトル
             * @param {Array<object>} weeklyOrders - その週の注文リスト
             * @param {string} reportId - 不足レポートのID
             * @param {boolean} isCollapsible - セクションを折りたたみ可能にするか
             * @param {boolean} showShortageReport - 不足レポートを表示するか
             * @returns {HTMLElement} 作成されたセクション要素
             */
            function createWeeklySection(title, weeklyOrders, reportId, isCollapsible = false, showShortageReport = true) {
                const section = document.createElement('div');
                section.className = 'weekly-section';

                let orderListHtml = `<li class="list-group-item text-muted">この期間の注文はありません。</li>`;
                if (weeklyOrders.length > 0) {
                    orderListHtml = weeklyOrders.map(o => {
                        // 各注文のアイテムを結合して表示
                        const itemsDisplay = o.items.map(item => {
                            // products[item.productId]が存在しない場合に対応
                            const productName = products[item.productId] ? products[item.productId].name : `不明な商品 (${item.productId})`;
                            return `${productName} x ${item.quantity}`;
                        }).join(', ');
                        return `
                            <li class="list-group-item order-item">
                                <div class="order-item-details">
                                    <span class="fw-bold">${o.dueDate}</span>: <strong>${o.customer}</strong> - ${itemsDisplay}
                                </div>
                                <i class="bi bi-pencil-square order-edit-icon" data-order-id="${o.id}"></i>
                            </li>
                        `;
                    }).join('');
                }

                let reportHtml = '';
                let shortageDetected = false;
                if (showShortageReport) { // showShortageReport が true の場合のみレポートを計算・表示
                    const shortageReport = calculateShortages(weeklyOrders);
                    if (shortageReport.productShortages.length > 0 || shortageReport.materialShortages.length > 0) {
                        shortageDetected = true;
                        reportHtml = `
                            ${shortageReport.productShortages.length > 0 ? `
                                <h6><i class="bi bi-box-seam-fill me-2"></i>不足している製造品</h6>
                                <ul class="list-group list-group-flush mb-3 shortage-list">
                                    ${shortageReport.productShortages.map(s => `<li class="list-group-item">${s.name}: ${s.shortage} ${s.unit} 不足</li>`).join('')}
                                </ul>` : ''}
                            ${shortageReport.materialShortages.length > 0 ? `
                                <h6><i class="bi bi-egg-fried me-2"></i>不足している原材料</h6>
                                <ul class="list-group list-group-flush shortage-list">
                                    ${shortageReport.materialShortages.map(s => `<li class="list-group-item">${s.name}: ${s.shortage.toFixed(1)} ${s.unit} 不足</li>`).join('')}
                                </ul>` : ''}
                        `;
                    } else {
                        reportHtml = '<p class="text-muted">在庫は十分にあります。</p>';
                    }
                } else {
                    reportHtml = '<p class="text-muted">この期間の在庫不足レポートは表示されません。</p>';
                }

                let cardHeaderContent;
                let cardBodyContent;

                if (isCollapsible) {
                    const collapseId = `collapse-${reportId}`; // 折りたたみコンテンツのID
                    cardHeaderContent = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${title}</span>
                            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    `;
                    cardBodyContent = `
                        <div class="collapse" id="${collapseId}">
                            <ul class="list-group list-group-flush">${orderListHtml}</ul>
                        </div>
                    `;
                } else {
                    cardHeaderContent = `<div class="card-header">${title}</div>`;
                    cardBodyContent = `<ul class="list-group list-group-flush">${orderListHtml}</ul>`;
                }

                // レポートカードのクラスを動的に設定
                const reportCardClass = showShortageReport ? (shortageDetected ? 'shortage-card' : 'sufficient-stock-card') : '';
                const reportHeaderClass = showShortageReport ? (shortageDetected ? 'shortage-header' : 'sufficient-stock-header') : '';

                section.innerHTML = `
                    <div class="card mb-3">
                        ${cardHeaderContent}
                        ${cardBodyContent}
                    </div>
                    ${showShortageReport ? `
                    <div class="card ${reportCardClass}">
                        <div class="card-header ${reportHeaderClass}">在庫不足レポート (${title.replace('の注文','').replace('の注文履歴','')})</div>
                        <div class="card-body" id="${reportId}">
                            ${reportHtml}
                        </div>
                    </div>` : ''}
                `;
                
                // 編集アイコンにイベントリスナーをアタッチ
                section.querySelectorAll('.order-edit-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        // 注文IDはタイムスタンプと乱数の組み合わせであるため、parseFloatで数値として扱います。
                        const orderId = parseFloat(e.target.dataset.orderId); 
                        openEditOrderModal(orderId);
                    });
                });

                return section;
            }

            // --- 計算ロジック ---
            /**
             * 指定された注文リストに基づいて、製品と原材料の不足を計算する関数
             * @param {Array<object>} targetOrders - 計算対象の注文リスト
             * @returns {object} 製品不足と原材料不足のリストを含むオブジェクト
             */
            function calculateShortages(targetOrders) {
                const productDemand = {}; // 製品ごとの合計需要
                targetOrders.forEach(order => {
                    // 各注文のアイテムをループして需要を計算
                    order.items.forEach(item => {
                        productDemand[item.productId] = (productDemand[item.productId] || 0) + item.quantity;
                    });
                });

                const productShortages = []; // 不足している製品のリスト
                const neededMaterials = {}; // 不足している製品を製造するために必要な原材料の合計
                for (const productId in productDemand) {
                    const demand = productDemand[productId];
                    const product = products[productId];
                    // 製品が存在しない場合はスキップ
                    if (!product) {
                        console.warn(`製品ID "${productId}" が見つかりません。`);
                        continue;
                    }
                    const shortage = demand - product.stock; // 需要 - 現在の在庫

                    if (shortage > 0) {
                        productShortages.push({ name: product.name, shortage: shortage, unit: product.unit });
                        
                        // 不足している製品を製造するために必要な原材料を計算
                        for (const materialId in product.recipe) {
                            const requiredAmount = product.recipe[materialId] * shortage;
                            neededMaterials[materialId] = (neededMaterials[materialId] || 0) + requiredAmount;
                        }
                    }
                }

                const materialShortages = []; // 不足している原材料のリスト
                for (const materialId in neededMaterials) {
                    const demand = neededMaterials[materialId];
                    const material = materials[materialId];
                    // 原材料が存在しない場合はスキップ
                    if (!material) {
                        console.warn(`原材料ID "${materialId}" が見つかりません。`);
                        continue;
                    }
                    const shortage = demand - material.stock; // 需要 - 現在の在庫

                    if (shortage > 0) {
                        materialShortages.push({ name: material.name, shortage: shortage, unit: material.unit });
                    }
                }

                return { productShortages, materialShortages };
            }

            // --- イベントハンドラ ---
            // 新規注文追加フォームの送信イベント
            document.getElementById('add-order-form').addEventListener('submit', async (e) => {
                e.preventDefault(); // フォームのデフォルト送信を防止
                
                const customerName = document.getElementById('customer-name').value;
                const dueDate = document.getElementById('due-date').value;
                const newOrderItemsContainer = document.getElementById('new-order-items-container');
                const productRows = newOrderItemsContainer.querySelectorAll('.new-order-item-row');

                if (productRows.length === 0) {
                    showToast('入力エラー', '少なくとも1つの商品を追加してください。', 'error');
                    return;
                }

                const newOrderItems = [];
                let anyProductAdded = false;
                productRows.forEach(row => {
                    const productId = row.querySelector('.product-select-new-order').value;
                    const quantity = parseInt(row.querySelector('.order-quantity-input').value);

                    // 数量が0以上であれば追加
                    if (productId && !isNaN(quantity) && quantity >= 0) {
                        newOrderItems.push({ productId: productId, quantity: quantity });
                        anyProductAdded = true;
                    }
                });

                if (anyProductAdded) {
                    const newOrder = {
                        id: Date.now() + Math.random(), // ユニークなIDとしてタイムスタンプと乱数を使用
                        customer: customerName,
                        items: newOrderItems, // 複数アイテムを保存
                        dueDate: dueDate,
                    };
                    
                    const { error } = await supabase.from('orders').insert([newOrder]);

                    if (error) {
                        console.error('Error adding order:', error);
                        showToast('エラー', '注文の追加に失敗しました。', 'error');
                    } else {
                        showToast('注文追加', `${newOrder.customer}の注文を追加しました。`, 'success');
                        // リアルタイムリスナーがUIを自動更新するため、renderAllは不要
                        // フォームをリセット
                        document.getElementById('add-order-form').reset();
                        document.getElementById('due-date').min = new Date().toISOString().split("T")[0]; // 納期入力の最小値を今日に再設定
                        newOrderItemsContainer.innerHTML = ''; // 商品行をクリア
                        addNewProductRowToForm(); // 最初の空の商品行を追加
                    }
                } else {
                    showToast('入力エラー', '商品と数量を正しく入力してください。', 'error');
                }
            });

            // 「商品を追加」ボタンのイベントリスナー (新規注文フォーム)
            document.getElementById('add-product-to-order').addEventListener('click', addNewProductRowToForm);

            // 「リセット」ボタンのイベントリスナー (新規注文フォーム)
            document.getElementById('reset-order-form').addEventListener('click', () => {
                document.getElementById('add-order-form').reset(); // フォーム全体をリセット
                document.getElementById('new-order-items-container').innerHTML = ''; // 商品行をクリア
                addNewProductRowToForm(); // 最初の空の商品行を追加
                document.getElementById('due-date').min = new Date().toISOString().split("T")[0]; // 納期入力の最小値を今日に再設定
                showToast('フォームリセット', '新規注文フォームの内容をリセットしました。', 'info');
            });

            /**
             * 新規注文フォームに商品選択行を追加する関数
             * @param {string} [productId=''] - 初期選択する商品ID
             * @param {number} [quantity=0] - 初期数量
             * @param {HTMLElement} [container=document.getElementById('new-order-items-container')] - 商品行を追加するコンテナ
             */
            function addNewProductRowToForm(productId = '', quantity = 0, container = document.getElementById('new-order-items-container')) {
                const newRow = document.createElement('div');
                newRow.className = 'new-order-item-row';
                const uniqueId = Date.now() + Math.random().toString(36).substring(2, 9); // ユニークなIDを生成

                let productOptionsHtml = '<option value="">商品を選択</option>';
                for (const id in products) {
                    const selected = (id === productId) ? 'selected' : '';
                    productOptionsHtml += `<option value="${id}" ${selected}>${products[id].name} (${products[id].unit})</option>`;
                }

                newRow.innerHTML = `
                    <select class="form-select form-select-sm product-select-new-order" style="width: 60%;" required>
                        ${productOptionsHtml}
                    </select>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-outline-secondary btn-minus-new-order" type="button" data-target-id="${uniqueId}">-</button>
                        <input type="number" class="form-control text-center order-quantity-input" value="${quantity}" min="0" required id="quantity-${uniqueId}">
                        <button class="btn btn-outline-secondary btn-plus-new-order" type="button" data-target-id="${uniqueId}">+</button>
                    </div>
                    <button class="btn btn-outline-danger btn-sm ms-2 remove-product-row" type="button">
                        <i class="bi bi-x-circle"></i>
                    </button>
                `;
                container.appendChild(newRow);

                // 新しく追加された行のイベントリスナーを設定
                const quantityInput = newRow.querySelector('.order-quantity-input');
                const minusButton = newRow.querySelector('.btn-minus-new-order');
                const plusButton = newRow.querySelector('.btn-plus-new-order');
                const removeButton = newRow.querySelector('.remove-product-row');

                quantityInput.addEventListener('change', (e) => {
                    let value = parseInt(e.target.value);
                    if (isNaN(value) || value < 0) { // 0を許可
                        e.target.value = 0;
                    }
                });

                minusButton.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    if (value > 0) { // 0より小さい値にはしない
                        quantityInput.value = value - 1;
                    }
                });

                plusButton.addEventListener('click', () => {
                    let value = parseInt(quantityInput.value);
                    quantityInput.value = value + 1;
                });

                removeButton.addEventListener('click', () => {
                    // 編集フォームでは、最低1つの商品が残るように制限
                    const currentContainer = removeButton.closest('#new-order-items-container') || removeButton.closest('#edit-order-items-container');
                    if (currentContainer.children.length > 1) {
                        currentContainer.removeChild(newRow);
                    } else {
                        showToast('警告', 'これ以上商品を削除できません。', 'warning');
                    }
                });
            }


            // 注文編集モーダルのインスタンス
            const editModalElement = document.getElementById('editOrderModal');
            const editModal = new bootstrap.Modal(editModalElement);
            const editOrderItemsContainer = document.getElementById('edit-order-items-container');

            /**
             * 注文編集モーダルを開き、選択された注文のデータを入力フィールドに設定する関数
             * @param {number} orderId - 編集する注文のID
             */
            function openEditOrderModal(orderId) {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    document.getElementById('edit-order-id').value = order.id;
                    document.getElementById('edit-customer-name').value = order.customer;
                    document.getElementById('edit-due-date').value = order.dueDate;
                    
                    // 既存の商品行をクリア
                    editOrderItemsContainer.innerHTML = '';

                    // 注文のアイテムを元に商品行を動的に追加
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(item => {
                            addNewProductRowToForm(item.productId, item.quantity, editOrderItemsContainer);
                        });
                    } else {
                        // アイテムがない場合は空の行を追加
                        addNewProductRowToForm('', 0, editOrderItemsContainer);
                    }

                    editModal.show(); // モーダルを表示
                }
            }

            // 「商品を追加」ボタンのイベントリスナー (編集モーダル)
            document.getElementById('add-product-to-edit-order').addEventListener('click', () => {
                addNewProductRowToForm('', 0, editOrderItemsContainer);
            });


            // 編集した注文を保存するボタンのクリックイベント
            document.getElementById('save-edited-order').addEventListener('click', async () => {
                // 注文IDはタイムスタンプと乱数の組み合わせであるため、parseFloatで数値として扱います。
                const orderId = parseFloat(document.getElementById('edit-order-id').value);
                const orderIndex = orders.findIndex(o => o.id === orderId);

                if (orderIndex !== -1) {
                    const updatedCustomerName = document.getElementById('edit-customer-name').value;
                    const updatedDueDate = document.getElementById('edit-due-date').value;
                    const updatedItems = [];
                    const productRows = editOrderItemsContainer.querySelectorAll('.new-order-item-row'); // クラス名は共通

                    let anyProductValid = false;
                    productRows.forEach(row => {
                        const productId = row.querySelector('.product-select-new-order').value;
                        const quantity = parseInt(row.querySelector('.order-quantity-input').value);

                        if (productId && !isNaN(quantity) && quantity >= 0) {
                            updatedItems.push({ productId: productId, quantity: quantity });
                            anyProductValid = true;
                        }
                    });

                    if (anyProductValid) {
                        const { error } = await supabase
                            .from('orders')
                            .update({ customer: updatedCustomerName, items: updatedItems, dueDate: updatedDueDate })
                            .eq('id', orderId); // IDが一致する行を更新

                        if (error) {
                            console.error('Error updating order:', error);
                            showToast('エラー', '注文情報の更新に失敗しました。', 'error');
                        } else {
                            showToast('注文編集', '注文情報を更新しました。', 'success');
                            // リアルタイムリスナーがUIを自動更新するため、renderAllは不要
                            editModal.hide(); // モーダルを閉じる
                        }
                    } else {
                        showToast('入力エラー', '少なくとも1つの商品を正しく入力してください。', 'error');
                    }
                } else {
                    showToast('エラー', '注文が見つかりませんでした。', 'error');
                }
            });
            
            // --- カスタム確認モーダル関連 ---
            let confirmCallback = null; // 確認モーダルのコールバック関数

            /**
             * カスタム確認モーダルを表示する関数
             * @param {string} message - 確認メッセージ
             * @param {function} onConfirm - 「OK」がクリックされたときに実行される関数
             */
            function showConfirmModal(message, onConfirm) {
                document.getElementById('confirmModalBody').textContent = message;
                confirmCallback = onConfirm; // コールバックを設定
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();
            }

            // 確認モーダルの「OK」ボタンのイベントリスナー
            document.getElementById('confirmModalConfirmBtn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(); // コールバックを実行
                }
                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                confirmModal.hide(); // モーダルを閉じる
            });

            // 注文を削除するボタンのクリックイベント (カスタム確認モーダルを使用)
            document.getElementById('delete-order-button').addEventListener('click', () => {
                // 注文IDはタイムスタンプと乱数の組み合わせであるため、parseFloatで数値として扱います。
                const orderId = parseFloat(document.getElementById('edit-order-id').value); 
                const customerName = document.getElementById('edit-customer-name').value;

                showConfirmModal(`${customerName}の注文を本当に削除しますか？`, async () => {
                    const { error } = await supabase
                        .from('orders')
                        .delete()
                        .eq('id', orderId); // IDが一致する行を削除

                    if (error) {
                        console.error('Error deleting order:', error);
                        showToast('エラー', '注文の削除に失敗しました。', 'error');
                    } else {
                        showToast('注文削除', `${customerName}の注文を削除しました。`, 'success');
                        // リアルタイムリスナーがUIを自動更新するため、renderAllは不要
                        editModal.hide(); // モーダルを閉じる
                    }
                });
            });


            // --- ヘルパー関数 ---
            /**
             * 今日の日付から指定日数後の日付を'YYYY-MM-DD'形式で取得する関数
             * @param {number} days - 今日からの日数
             * @returns {string} フォーマットされた日付文字列
             */
            function getFutureDate(days) {
                const date = new Date();
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            /**
             * 指定された日付の週の開始日（月曜日）を取得する関数
             * @param {Date} date - 基準となる日付オブジェクト
             * @returns {Date} 週の開始日（月曜日）の日付オブジェクト
             */
            function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay(); // 0 (日曜日) から 6 (土曜日)
                // 月曜日を週の開始とするため調整
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
                const monday = new Date(d.setDate(diff));
                monday.setHours(0, 0, 0, 0); // 時刻を00:00:00に設定
                return monday;
            }

            // --- 初期表示 ---
            initialize(); // アプリケーションの初期化と表示
        });
    </script>
</body>
</html>
